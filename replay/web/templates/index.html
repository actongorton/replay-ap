{% extends 'base.html' %}

{% block content %}
<style type="text/css">
    a.ajax-toggle  {
        font-weight: bold;
        font-style: normal;
        color: rgb(91, 129, 0);
    }
    a.mode-off {
        color: rgb(210, 210, 210);
        font-style: italic;
        font-weight: normal;
    }
</style>
<div class="row">
    <div class="col-md-12">
        <p style="font-size: 24px;"><strong>Replay AP</strong> is an engine for replaying AP election tests. To use <strong>Replay AP</strong> with your <a href="https://github.com/newsdev/election-2018">election app</a>, export this environment variable to point your loader away from the AP and toward Deja-Vu.</p>
        <p>
            <pre>

                <code>export AP_API_BASE_URL="{{ PUB_URL }}/elections/"</code>
            </pre>
        </p>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <h1>Upcoming elections</h1>
        <table class="table">
        <tr>
            <th>Election date</th>
            <th>Status</th>
            <th>Position</th>
            <th>Playback speed</th>
            <th>Error mode</th>
        </tr>
        {% for e in current %}
        <tr id="election-{{ e.racedate }}">
            <td class="col-md-2">
                <a href="{{ PUB_URL }}/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">{{ e.racedate }}</a>
                <a target="_blank" style="color: #888;font-size:11px;" href="https://console.cloud.google.com/storage/browser/{{ STORAGE_BUCKET }}/apps/replay-ap/{{ e.racedate }}/national?project=nytint-prd"><em>see files &raquo;</em></a>
            </td>
            <td class="status">
                {% if e.status == False %}
                <a class="startstop btn btn-default btn-sm" data-command="start">Start recording</a>
                {% else %}
                <a class="startstop btn btn-warning btn-sm" data-command="stop">Stop recording</a>
                {% endif %}
            </td>
            <td class="position">
                <strong>{{ e.position }}</strong>&nbsp;/&nbsp;{{ e.total_positions }}&nbsp;
                <a class="ajax" id="position-zero" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">&#x21BA;</a>
            </td>
            <td class="playback">
                <strong>{{ e.playback }}</strong>&nbsp;
                <a class="ajax" id="playback-up" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">&uarr;</a>&nbsp;
                <a class="ajax" id="playback-down" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">&darr;</a>&nbsp;
                <a class="ajax" id="playback-one" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">&#x21BA;</a>
            </td>
            <td class="errormode">
                <a class="{% if e.errormode %}{% else %}mode-off {% endif %}ajax-toggle" id="errormode" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">500</a>&nbsp;&nbsp;
                <a class="{% if e.ratelimited %}{% else %}mode-off {% endif %}ajax-toggle" id="ratelimited" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">403</a>
            </td>
        </tr>
        {% endfor %}
        </table>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <h1>Old elections</h1>
        <table class="table">
        <tr>
            <th>Election date</th>
            <th>Position</th>
            <th>Playback speed</th>
            <th>Error mode</th>
        </tr>
        {% for e in past %}
        <tr id="election-{{ e.racedate }}">
            <td class="col-md-2">
                <a href="{{ PUB_URL }}/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">{{ e.racedate }}</a>
                <a target="_blank" style="color: #888;font-size:11px;" href="https://console.cloud.google.com/storage/browser/int.nyt.com/apps/replay-ap/{{ e.racedate }}/national?project=nytint-prd"><em>see files &raquo;</em></a>
            </td>
            <td class="position">
                <strong>{{ e.position }}</strong>&nbsp;/&nbsp;{{ e.total_positions }}&nbsp;
                <a class="ajax" id="position-zero" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">&#x21BA;</a>
            </td>
            <td class="playback">
                <strong>{{ e.playback }}</strong>&nbsp;
                <a class="ajax" id="playback-up" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">&uarr;</a>&nbsp;
                <a class="ajax" id="playback-down" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">&darr;</a>&nbsp;
                <a class="ajax" id="playback-one" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">&#x21BA;</a>
            </td>
            <td class="errormode">
                <a class="{% if e.errormode %}{% else %}mode-off {% endif %}ajax-toggle" id="errormode" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">500</a>&nbsp;&nbsp;
                <a class="{% if e.ratelimited %}{% else %}mode-off {% endif %}ajax-toggle" id="ratelimited" href="/elections/{{ e.racedate }}?national={{ e.national|lower }}&level=ru">403</a>
            </td>
        </tr>
        {% endfor %}
        </table>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script type="text/javascript">
    $(function(){
        var recording_click_handler = function(el){
            el.preventDefault();
            $el = $(this);
            var RACEDATE = $el.parent('td').parent('tr').attr('id').split('election-')[1];
            var ACTION = $el.attr('data-command');
            console.log('/recording/' + RACEDATE + '/' + ACTION + '/');
            $.ajax({
                type: "GET",
                url: '/recording/' + RACEDATE + '/' + ACTION + '/',
                success: function(response){
                    window.location.reload();
                }
            });            
        }

        var ajax_url = function(racedate, action, param_name, direction, url){
            var params = {}
            params[param_name] = parseInt($($('#' + racedate + ' .' + action + ' strong')[0]).text());
            if (direction === "up") {
                params[param_name] = params[param_name] + 1;
            };
            if (direction === "down") {
                params[param_name] = params[param_name] - 1;
            };
            if (direction == "zero") {
                params[param_name] = 0;
            };
            if (direction == "one") {
                params[param_name] = 1;
            };
            $.ajax({
                type: "GET",
                url: url,
                data: params,
                success: function(response){
                    $($('#' + racedate + ' .' + action + ' strong')[0]).text(params[param_name]);
                    $($('#' + racedate + ' .' + action + ' strong')[1]).text(params[param_name]);
                }
            });

        };

        var ajax_click_handler = function(el){
            el.preventDefault();
            $el = $(this);
            var RACEDATE = $el.parent('td').parent('tr').attr('id');
            var ACTION = $el.parent('td').attr('class');
            ajax_url(
                RACEDATE,
                ACTION,
                $el.attr('id').split('-')[0],
                $el.attr('id').split('-')[1],
                $el.attr('href')
            );
        };

        var ajax_toggle_handler = function(el) {
            el.preventDefault();
            $el = $(this);
            params = {}
            params[$el.attr('id')] = false
            if ($el.hasClass('mode-off')) {
                params[$el.attr('id')] = true
            }
            $.ajax({
                type: "GET",
                url: $el.attr('href'),
                data: params,
                success: function(response){
                    console.log(params, 'success');
                    $el.toggleClass('mode-off');
                }
            })
        }

        $('a.ajax').on('click', ajax_click_handler);
        $('a.ajax-toggle').on('click', ajax_toggle_handler);
        $('a.startstop').on('click', recording_click_handler);
    });
</script>
{% endblock %}
